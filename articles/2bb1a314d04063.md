---
title: "åƒ•ã®å¥½ã¿ã‚’ä¸€æ–¹çš„ã«æ±ºã‚ã¤ã‘ã‚‹å¯©è­°ç”¨Botã«ç‰©ç”³ã™ãŸã‚ã®æ©Ÿèƒ½è¿½åŠ ã‚’ã—ã¾ã—ãŸ"
emoji: "ğŸ¤–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["bedrock", "slack", "typescript", "lambda"]
published: true
publication_name: "moneyforward"
---

ã“ã‚“ã«ã¡ã¯ã€‚ãƒ€ã‚¤ã®å¤§å†’é™ºã‚¬ãƒå‹¢ã®[bun913](https://x.com/bun76235104)ã¨ç”³ã—ã¾ã™ã€‚

ç§ã¯å‰å›ã®è¨˜äº‹ã§ã€Œ**åŒåƒšã‹ã‚‰å‹§ã‚ã‚‰ã‚Œã‚‹ã‚¢ãƒ‹ãƒ¡ä½œå“ã‚’ç§ãŒè¦–è´ã™ã‚‹ã¹ãã‹ã©ã†ã‹**ã€ã‚’åˆ¤å®šã™ã‚‹ChatBotã‚’ä½œæˆã—ã¾ã—ãŸã€‚

https://zenn.dev/moneyforward/articles/3eadb58169f235

ãŸã ã—éŸ³æ¥½æ€§ã®é•ã„ã§ã“ã®Bot:å¯©è­°ãƒãƒ³ã¨ã¯ã†ã¾ãã‚„ã£ã¦ã„ã‘ãã†ã«ãªã„ã“ã¨ãŒã‚ã‹ã£ãŸã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹æˆã«å¤‰æ›´ã—ã€å½¼ã«ã¯å¯¾è©±ã®é‡è¦æ€§ã‚’è¦šãˆã¦ã‚‚ã‚‰ã†ã“ã¨ã«ã—ã¾ã—ãŸã€‚

![singi2-architecture](/images/singibot2/architecture.png)

ãªãŠã€ä»Šå›ã®è¨˜äº‹ã¯ä»¥ä¸‹ã®è¨˜äº‹ã®æ§‹æˆã‚„ã‚³ãƒ¼ãƒ‰ã‚’å¤§ã„ã«å‚è€ƒã«ã•ã›ã¦ã„ãŸã ã„ã¦ãŠã‚Šã¾ã™ãŒã€æ§‹æˆã‚’ App Runner ã‹ã‚‰ Lambda + API Gateway ã«å¤‰æ›´ã—ãŸã‚Šã€ã‚»ã‚­ãƒ¥ã‚¢ã«ä½¿ãˆã‚‹ãŸã‚ã®å·¥å¤«ã‚’å°‘ã—åŠ ãˆã¦ã„ã¾ã™ã€‚

https://dev.classmethod.jp/articles/slack-chat-gpt-bot/

ã“ã¡ã‚‰ã®è¨˜äº‹ã¯2023å¹´3æœˆã®æ™‚ç‚¹ã§æŠ•ç¨¿ã•ã‚Œã¦ã„ã‚‹è¨˜äº‹ã§ã‚ã‚‹ãŸã‚ã€ãŠãã‚‰ãç¾åœ¨ã¯ã‚‚ã£ã¨å“è³ªã®å„ªã‚ŒãŸã‚¢ãƒ—ãƒªã‚’ä½œã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ã ã‚ã†ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚

ã€Œã‚³ã‚¹ãƒˆã€ã€Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ã€Œä½¿ã£ã¦ã‚‚ã‚‰ã†ãŸã‚ã®å“è³ªã€ã‚’è€ƒæ…®ã—ãŸä¸Šã§è¿…é€Ÿãªã‚¹ãƒ”ãƒ¼ãƒ‰ã§ãŸã‚ã«ãªã‚‹ãƒ–ãƒ­ã‚°ã‚’æŠ•ç¨¿ã—ã¦ã„ã‚‹ç­†è€…ã®æ–¹ã®ç´ æ™´ã‚‰ã—ã•ã‚’æ„Ÿã˜ã¦ã„ã¾ã™ã€‚

ãªãŠã€ç§ã®ä½œæˆã—ã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«æ ¼ç´ã—ã¦ãŠã‚Šã¾ã™ã®ã§ã€å…¨ä½“åƒã‚„è©³ç´°ã‚’çŸ¥ã‚ŠãŸã„æ–¹ã¯ã”å‚ç…§ãã ã•ã„ã€‚

https://github.com/bun913/singi-bot

## å…ˆã«çµè«–

ä»¥å‰ã®ãƒ–ãƒ­ã‚°è¨˜äº‹ã§ä½œæˆã—ã¦ã„ãŸ`å¯©è­°ãƒãƒ³`ã¨ã„ã†Botã«ä»¥ä¸‹ã®ã‚ˆã†ãªéå»ã®å¯¾è©±ã‚’è¸ã¾ãˆãŸä¸Šã§ã€ç§ã®ä½œå“ã‚’è¦‹ã‚‹ã¹ãã‹ã©ã†ã‹åˆ¤å®šã™ã‚‹æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã«å¯¾è©±ã®çµæœã‚’è¸ã¾ãˆã¦ã€ç§ã®å¥½ã¿ã«åˆã†ã‹ã©ã†ã‹ã‚’åˆ¤å®šã—ã¦ãã‚Œã¾ã™ã€‚

![singi2](/images/singibot2/singi2-success.jpg)

## ãªãœæ©Ÿèƒ½ã‚’è¿½åŠ ã—ãŸã®ã‹

å…ˆã«ç”³ã—ä¸Šã’ãŸã¨ãŠã‚Šã€ã€Œå…¥ç¤¾3é€±é–“ã§åŒåƒšã‹ã‚‰ãŸãã•ã‚“ã®ã‚¢ãƒ‹ãƒ¡ä½œå“ã‚’å‹§ã‚ã‚‰ã‚Œã¦æŒããã‚Œãªã„ã€ã¨ã„ã†~~èŒ¶ç•ª~~è¨€ã„è¨³ã§ã€å¯©è­°ã—ã¦ãã‚Œã‚‹Botã‚’ä½œæˆã—ã¦ã„ã¾ã—ãŸã€‚

![singi1](/images/singibot/singiman1.jpg)

ãŸã ã€ã“ã®å¯©è­°ãƒãƒ³ã«ã¯æ‰€è©®æ•°ç™¾æ–‡å­—ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ç§ãŒå¥½ã¿ãã†ãªä½œå“ã®æƒ…å ±ã—ã‹ä¸ãˆã¦ã„ã¾ã›ã‚“ã€‚

ãã®ä¸Šã€3ã¤ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¿”äº‹ã—ã‹è¨±ã—ã¦ã„ãªã„ãŸã‚ã€å½“ç„¶ä»¥ä¸‹ã®ã‚ˆã†ãªçŠ¶æ³ã«ãªã‚Šã¾ã™ã€‚

![singi-chaous](/images/singibot2/singi2-fail.jpg)

ã“ã‚Œã‚‰ã‚’ä»¥ä¸‹ã®æ”¹å–„ã‚’åŠ ãˆã‚‹ã“ã¨ã§è§£æ±ºã—ã‚ˆã†ã¨è€ƒãˆã¾ã—ãŸã€‚

- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ”¹å–„
  - 3ç¨®é¡ã®è¿”äº‹ã—ã‹è¨±ã•ãªã„ã®ã¯ã¡ã‚‡ã£ã¨ã­ãƒ»ãƒ»ãƒ»
  - å¯©è­°ãƒãƒ³ã¨ã¯è¨€ã„ã¤ã¤ã‚‚ã€å‡¡åº¸ãªã‚‹AI Chatbotã«ãªã£ã¦ã‚‚ã‚‰ãŠã†ã‹ãªï¼
- éå»ã®å¯¾è©±ã®çµæœã‚’è¸ã¾ãˆãŸåˆ¤å®š
  - éå»ã®ä¼šè©±ã®å±¥æ­´ã‚’DynamoDBã«ä¿å­˜ã—ã¦ã€ãã‚Œã‚‚Bedrockã«æ¸¡ã—ã¾ã™
  - ãã®ä»–DynamoDBãŒå¿…è¦ãªç†ç”±ã¯ãœã²ä¸Šè¨˜ãƒ–ãƒ­ã‚°ã®ç­†è€…æ§˜ã®ç™»å£‡è³‡æ–™ã‚’ã”è¦§ãã ã•ã„
  - https://www.docswell.com/s/dyoshikawa/ZQ896X-slack-bot-chat-gpt#p14

## æ©Ÿèƒ½è¿½åŠ ã®éç¨‹

å†’é ­ã§ãŠä¼ãˆã—ãŸã¨ãŠã‚Šã€ã“ã®è¨˜äº‹ã¯æŠ€è¡“çš„ã«ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¤ã¤ã€é•ã†æ§‹æˆã§ä½œæˆã—ã¦ã„ã¾ã™ã€‚

https://dev.classmethod.jp/articles/slack-chat-gpt-bot/

### å‰å›ã®æ§‹æˆã¨ã®å·®åˆ†

å‰å›ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹æˆã§ã—ãŸã€‚

![before](/images/singibot2/before.png)

å‰å›æ™‚ç‚¹ã§ã¯ã‚ãã¾ã§ãã®å ´ãã®å ´ã®å›ç­”ã—ã‹ã§ããªã„ChatBotã§ã—ãŸãŒã€ä»Šå›ã¯DynamoDBã‚’åŠ ãˆã¦éå»ã®ä¼šè©±ã‚’è¨˜éŒ²ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

ã¾ãŸã€ã€Œãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ã‚‹Lambdaã€ã¨ã€Œç”ŸæˆAIã«å•ã„åˆã‚ã›ã¦Slackã«è¿”ä¿¡ã™ã‚‹Lambdaã€ã‚’åˆ†ã‘ã¦ç–çµåˆã«ã—ã¦ã„ã¾ã—ãŸãŒã€ä»Šå›ã¯ä¸€ã¤ã®Lambdaã§å‡¦ç†ã‚’è¡Œã†ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

![singi2-architecture](/images/singibot2/architecture.png)

### AWS CDK ã®æ§‹æˆ

å‰å›ã«å¼•ãç¶šãã€Stackã¨ã—ã¦ã¯äºŒã¤ã«åˆ†ã‘ã¦ã„ã¾ã™ã€‚

```ts
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { WebHandler } from '../stacks/singi-bot/webHandler';
import { StringParameter } from 'aws-cdk-lib/aws-ssm';
import { TableEncryptionV2 } from 'aws-cdk-lib/aws-dynamodb';

const commonParams = {
  slackSigninSecret: "/singi-bot/slackSigninSecret",
  slackBotToken: "/singi-bot/slackBotToken",
  dummyString: "dummy",
  messageTableName: "slackChatGptBotNode-messages",
}

export type Commonparams = typeof commonParams

// ä¸€åº¦ä½œæˆã—ãŸã‚‰CDKã§ã¯ãã®å¾Œå¤‰æ›´ã—ãªã„ã€ã¤ã¾ã‚ŠCDKã§å¤‰æ›´ç®¡ç†ã—ãªã„ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹Stack
export class ManuallyManagedResourceStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);
    
    // Create Parameter Store and manage it manually
    const slackSigninSecret = new StringParameter(this, "slackSigninSecret", {
      parameterName: commonParams.slackSigninSecret,
      stringValue: commonParams.dummyString,
    })
    
    // Create Parameter Store and manage it manually
    const slackBotToken = new StringParameter(this, "slackBotToken", {
      parameterName: commonParams.slackBotToken,
      stringValue: commonParams.dummyString
    })
    
    // Create DynamoDB
    const messagesTable = new cdk.aws_dynamodb.TableV2(this, "messagesTable", {
      tableName: commonParams.messageTableName,
      partitionKey: {
        name: "id",
        type: cdk.aws_dynamodb.AttributeType.STRING,
      },
      // TODO: æœ¬ç•ªç’°å¢ƒã§ã¯DESTROYã‚’ä½¿ã‚ãªã„
      removalPolicy: cdk.RemovalPolicy.DESTROY,
      encryption: TableEncryptionV2.awsManagedKey()
    });

    messagesTable.addGlobalSecondaryIndex({
      indexName: "threadTsIndex",
      partitionKey: {
        name: "threadTs",
        type: cdk.aws_dynamodb.AttributeType.STRING,
      },
    });
  }
}

// ã“ã£ã¡ã¯CDKã§è¨­å®šå¤‰æ›´ã‚‚å«ã‚ã¦ç®¡ç†ã—ã¦ã„ããƒªã‚½ãƒ¼ã‚¹
export class SingiBotStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);
    
    const webHandler = new WebHandler("singi-bot", this, commonParams)
  }
}

```

`ManuallyManagedResourceStack` ã¨ã„ã†Stackã¯ã€æ–‡å­—é€šã‚Šã€Œæ‰‹å‹•ã§ç®¡ç†ã—ãŸã„ãƒªã‚½ãƒ¼ã‚¹ã€ã‚’ä½œæˆã™ã‚‹Stackã§ã™ã€‚

- Lambdaã«æŒãŸã›ãŸã„ç§˜å¯†æƒ…å ±
  - Slackã¨ã‚„ã‚Šã¨ã‚Šã‚’ã™ã‚‹ãŸã‚ã®2ã¤ã®ç§˜å¯†æƒ…å ±
- DynamoDB
  - éå»ã®å¯¾è©±ã®å±¥æ­´ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®ãƒ†ãƒ¼ãƒ–ãƒ«

`DynamoDB` ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã‚ã‚Šå¸¸ã«çŠ¶æ…‹ãŒå¤‰ã‚ã‚‹ãŸã‚ã€ä»Šå›ã¯IaCã§çŠ¶æ…‹ã‚’ç®¡ç†ã—ãŸãã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ï¼ˆä¾‹: ã¡ã‚‡ã£ã¨ã—ãŸå¤‰æ›´ã§ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã‚‹ã‚ˆã†ãªã“ã¨ã¯é¿ã‘ãŸã„ï¼‰

ã‚ˆã£ã¦ã€`ManuallyManagedResourceStack` ã§ã¯ `ä¸€åº¦ä½œã£ãŸã‚‰ã‚ã¨ã¯åŸºæœ¬çš„ã«IaCã§å¤‰æ›´ã—ãªã„` ãƒªã‚½ãƒ¼ã‚¹ã®ã¿ä½œæˆã—ã¦ã‚‚ã‚‰ã„ã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šåˆå›æ™‚ã ã‘ã€ `ManuallyManagedResourceStack` ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€ãã‚Œä»¥é™ã¯ `SingiBotStack` ã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚Œã°ã€Œã„ã„æ„Ÿã˜ã«å¤‰æ›´ã•ã‚Œã¦ã»ã—ã„ã€éƒ¨åˆ†ã¨ã€Œæ‰‹å‹•ã§ç®¡ç†ã—ãŸã„ã€‚å¤‰ã«å¤‰æ›´ã•ã‚ŒãŸããªã„ã€éƒ¨åˆ†ã‚’åˆ†ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

### AWS CDK ã«ã‚ˆã‚‹ Lambda + API Gateway ã®æ§‹ç¯‰

ä»Šå›ã‚‚æ§‹æˆã¨ãªã‚‹ Lambda + API Gateway ãªã©ã‚’æ§‹ç¯‰ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã§ã™ãŒã€ä»Šå›ã‚‚é•·ã„ã®ã§æŠ˜ã‚ŠãŸãŸã‚“ã§ãŠãã¾ã™ã€‚

:::details Lambda + API Gateway ã®æ§‹ç¯‰

```ts
import * as path from "path"
import { NodejsFunction } from "aws-cdk-lib/aws-lambda-nodejs"
import { Construct } from "constructs"
import {
  ParamsAndSecretsLayerVersion,
  ParamsAndSecretsLogLevel,
  ParamsAndSecretsVersions,
  Runtime,
} from "aws-cdk-lib/aws-lambda"
import { Duration } from "aws-cdk-lib"
import { RetentionDays } from "aws-cdk-lib/aws-logs"
import { Commonparams } from "../../lib/singi-bot-stack"
import { HttpApi, HttpMethod } from "aws-cdk-lib/aws-apigatewayv2"
import { HttpLambdaIntegration } from "aws-cdk-lib/aws-apigatewayv2-integrations"
import { Effect, PolicyStatement } from "aws-cdk-lib/aws-iam"
import { StringParameter } from "aws-cdk-lib/aws-ssm"
import { ITable, ITableV2, TableV2 } from "aws-cdk-lib/aws-dynamodb"

export class WebHandler {
  readonly prefix: string
  readonly construct: Construct
  readonly commonParams: Commonparams

  readonly lamdaExtension: ParamsAndSecretsLayerVersion
  readonly messageTable: ITable
  readonly lambdaFunc: NodejsFunction
  readonly api: HttpApi

  constructor(
    prefix: string,
    construct: Construct,
    commonparams: Commonparams
  ) {
    this.prefix = prefix
    this.construct = construct
    this.commonParams = commonparams

    this.lamdaExtension = this.getLambdaExtension()
    this.messageTable = this.getDynamoDBTable()
    this.lambdaFunc = this.crearteLambda()
    this.api = this.createGateway()
    this.grant()
  }

  // Lambdaã‹ã‚‰Slackã®Tokenãªã©ã®ç§˜å¯†æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½
  // https://dev.classmethod.jp/articles/lambda-get-paramater/
  // ä»Šå›ã¯Lambdaã‹ã‚‰ç›´æ¥å‚ç…§ã™ã‚‹ã“ã¨ã§ã€Lambdaã®é–‹ç™ºè€…ã™ã‚‰ç§˜å¯†æƒ…å ±ã‚’è¦‹ãªã„ã§æ¸ˆã‚€ã‚ˆã†ã«ã—ã¦ã„ã¾ã™
  private getLambdaExtension(): ParamsAndSecretsLayerVersion {
    return ParamsAndSecretsLayerVersion.fromVersion(
      ParamsAndSecretsVersions.V1_0_103,
      {
        cacheSize: 500,
        logLevel: ParamsAndSecretsLogLevel.INFO,
      }
    )
  }

  // åˆ¥ã®Stackã§ä½œæˆã—ãŸDynamoDBã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å–å¾—
  private getDynamoDBTable(): ITableV2 {
    return TableV2.fromTableName(
      this.construct,
      "messagesTable",
      this.commonParams.messageTableName
    )
  }

  // Lambdaã®ä½œæˆ
  // 1024ã ã¨ãƒ¡ãƒ¢ãƒªä¸è¶³ã«ãªã‚‹ã“ã¨ãŒã‚ã£ãŸã®ã§memorySizeã‚’ã¡ã‚‡ã£ã¨å¤šã‚ã«å–ã£ã¦ã„ã¾ã™
  private crearteLambda(): NodejsFunction {
    const funcName = `${this.prefix}-inque`
    const entry = path.join(process.cwd(), "lambda", "lambda.ts")

    return new NodejsFunction(this.construct, funcName, {
      entry,
      functionName: funcName,
      runtime: Runtime.NODEJS_20_X,
      timeout: Duration.seconds(10),
      memorySize: 2056,
      environment: {
        SLACK_BOT_TOKEN_PARAM: this.commonParams.slackBotToken,
        SLACK_SIGNING_SECRET_PARAM: this.commonParams.slackSigninSecret,
        MESSAGE_TABLE_NAME: this.commonParams.messageTableName,
      },
      paramsAndSecrets: this.lamdaExtension,
      // TODO: logä¿å­˜æœŸé–“ã¨ä¿å­˜å ´æ‰€ã‚’å¤‰æ›´ã™ã‚‹
      logRetention: RetentionDays.ONE_DAY,
    })
  }

  // API Gatewayã®ä½œæˆ
  private createGateway(): HttpApi {
    const httpLambdaIntegRation = new HttpLambdaIntegration(
      `${this.prefix}-integ`,
      this.lambdaFunc
    )
    const api = new HttpApi(this.construct, `${this.prefix}-gateway`, {
      apiName: `${this.prefix}-gateway`,
      createDefaultStage: true,
    })
    api.addRoutes({
      path: "/slack/singi",
      methods: [HttpMethod.POST],
      integration: httpLambdaIntegRation,
    })
    return api
  }

  private grant() {
    // BedrockRuntimeã®invokeModelã‚’å‘¼ã³å‡ºã™ãŸã‚ã®æ¨©é™ã‚’ä»˜ä¸
    const policy = new PolicyStatement({
      effect: Effect.ALLOW,
      actions: ["bedrock:InvokeModel"],
      resources: ["*"],
    })
    this.lambdaFunc.addToRolePolicy(policy)
    // Lambdaã« SSM ParameterStoreã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ä»˜ä¸
    const slackSigninSecretParam =
      StringParameter.fromStringParameterAttributes(
        this.construct,
        "slackSigninSecretParam",
        {
          parameterName: this.commonParams.slackSigninSecret,
        }
      )
    const slackBotTokenParam = StringParameter.fromStringParameterAttributes(
      this.construct,
      "slackBotTokenParam",
      {
        parameterName: this.commonParams.slackBotToken,
      }
    )
    

    slackSigninSecretParam.grantRead(this.lambdaFunc)
    slackBotTokenParam.grantRead(this.lambdaFunc)
    
    // ã†ã¾ãGlobalSecondaryIndexã¸ã®æ¨©é™ãŒä»˜ä¸ã§ããªã‹ã£ãŸã®ã§æ˜ç¤ºçš„ã«ä»˜ä¸
    this.messageTable.grantReadWriteData(this.lambdaFunc)
    const indexPolicy = new PolicyStatement({
      effect: Effect.ALLOW,
      actions: ["dynamodb:Query"],
      resources: [
        `${this.messageTable.tableArn}/index/*`,
      ],
    });
    
    this.lambdaFunc.addToRolePolicy(indexPolicy);
  }
}

```

ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦ã‚‚æ›¸ã„ã¦ãŠã‚Šã¾ã™ãŒã€Lambdaã‹ã‚‰ SSM Parameter Store ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ç§˜å¯†æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

https://dev.classmethod.jp/articles/lambda-get-paramater/

ã“ã‚Œã«åˆã‚ã›ã¦Lambdaã‚³ãƒ¼ãƒ‰ä¸­ã«ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¼‰ã™ã‚‹ã“ã¨ã§ã€æ©Ÿå¯†æƒ…å ±ã‚’ã‚ˆã‚Šã‚»ã‚­ãƒ¥ã‚¢ã«åˆ©ç”¨ã§ãã¾ã™ã€‚

ãªãŠä»Šå›ã¯ã‚³ã‚¹ãƒˆã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å…¼ã­åˆã„ã§ Parameter Store ã«ç§˜å¯†æƒ…å ±ã‚’æ ¼ç´ã—ã¦ã„ã¾ã™ãŒã€ Secrets Manager ã§ã‚‚åŒæ§˜ã®ä»•çµ„ã¿ã‚’æ´»ç”¨ã§ãã¾ã™ã€‚

```ts
// ã“ã¡ã‚‰ã®ãƒ–ãƒ­ã‚°ã‚’ã»ã¼ãã®ã¾ã¾åˆ©ç”¨ã•ã›ã¦ã„ãŸã ã„ã¦ã„ã¾ã™
// https://dev.classmethod.jp/articles/aws-cdk-v28-40-aws-parameter-and-secrets-lambda-extension/
// ä¸€ã‹ã‚‰åã¾ã§DevelopersIOã®ãŠä¸–è©±ã«ãªã£ã¦ã„ã¾ã™ã­
const slackBotToken = await getParameter(
  process.env.SLACK_BOT_TOKEN_PARAM || ""
)

import axios from "axios"

const AWS_SESSION_TOKEN = process.env.AWS_SESSION_TOKEN || ""

export const getParameter = async (path: string): Promise<string> => {
  const res =  await axios.get(
    "http://localhost:2773/systemsmanager/parameters/get",
    {
      params: {
        name: encodeURIComponent(path)
      },
      headers: {
        "X-Aws-Parameters-Secrets-Token": AWS_SESSION_TOKEN,
      },
    }
  )
  return res.data.Parameter.Value
}

```
:::

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ¼ãƒ‰

### Slack ã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¦è¿”äº‹ã‚’ã™ã‚‹Lambda

ã“ã¡ã‚‰ã‚‚é•·ã„ã®ã§ã€å…¨ä½“åƒã‚’çŸ¥ã‚ŠãŸã„æ–¹ã¯ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

https://github.com/bun913/singi-bot/blob/main/lambda/lambda.ts

å…¨ä½“ã®æµã‚Œã¯[[Slack][AWSã‚µãƒ¼ãƒãƒ¬ã‚¹]Slackãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã¸ã®èª­ã¿å–ã‚Šæ¨©é™ãŒã»ã¼ã‚¼ãƒ­ã®ChatGPTãƒœãƒƒãƒˆã‚’ä½œã‚‹](https://dev.classmethod.jp/articles/slack-chat-gpt-bot/)ã¨åŒã˜ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

- Slackã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚‹
- ä¸€æ—¦ã¨ã‚Šã‚ãˆãšå¯©è­°ãƒãƒ³ã‹ã‚‰ã€Œã—ã°ã—å¾…ãŸã‚Œã‚ˆã€çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”å´ï¼ˆæ„å›³ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ï¼‰
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãªã‚“ã‚‰ã‹ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ—©ãè¿”ã—ãŸã„
  - å¯©è­°ãƒãƒ³ãŒè¿”äº‹ã‚’ã™ã‚‹å‰ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰å†åº¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‰ã‚Œã¦ã—ã¾ã†ã¨ã€å¯¾è©±å±¥æ­´ãŒãŠã‹ã—ããªã‚‹ãŸã‚
    - Bedrockã«ä¸ãˆã‚‹éš›ã«ã¯ ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ Berdrock â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ ãƒ»ãƒ»ãƒ»ã¨ã„ã†é †ã§ã®ã‚„ã‚Šã¨ã‚Šã‚’ä¸ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å†…å®¹ã‚’DynamoDBã«ä¿å­˜
- åŒã˜ã‚¹ãƒ¬ãƒƒãƒ‰å†…ã®éå»ã®å¯¾è©±ã‚’å–å¾—
- 10æ•°ä»¶ã‚’è¶…ãˆã‚‹éå»ã®ä¼šè©±ã‚’å‰Šé™¤ã—ã¾ã™
  - å˜ç´”ã«ã‚³ã‚¹ãƒˆã‚’æ°—ã«ã—ã¦ã„ã‚‹ã ã‘ã§ã™
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’Bedrockã«ä¸ãˆã‚‹å½¢ã«æ•´å½¢ã—ã¦
- Bedrockã«ä¸ãˆã¦è¿”ç­”ã‚’å—ã‘å–ã‚Šã¾ã™
- ãã®è¿”ç­”ã‚’DynamoDBã«ä¿å­˜
- è¿”ç­”ã‚’Slackã«è¿”å´

ã¨ã„ã†ã‚ˆã†ãªæµã‚Œã§ã™ã€‚

### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

ã“ã“ã¾ã§ãã‚‹ã¨æ°—æŒã¡ã®ã„ã„ã‚‚ã®ã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚‚[[Slack][AWSã‚µãƒ¼ãƒãƒ¬ã‚¹]Slackãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã¸ã®èª­ã¿å–ã‚Šæ¨©é™ãŒã»ã¼ã‚¼ãƒ­ã®ChatGPTãƒœãƒƒãƒˆã‚’ä½œã‚‹](https://dev.classmethod.jp/articles/slack-chat-gpt-bot/)ã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚

æœ¬å½“ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ãŠä¸–è©±ã«ãªã£ã¦ã„ã¾ã™ã€‚

```ts
export const rulePrompt = `
ã‚ãªãŸã¯ã€Œå¯©è­°ãƒãƒ³ã€ã§ã™ã€‚ä»¥ä¸‹ã®åˆ¶ç´„ã‚’å³å¯†ã«å®ˆã£ã¦ä¼šè©±ã—ã¦ãã ã•ã„ã€‚

# åˆ¶ç´„æ¡ä»¶

* åå‰ã‚’èã‹ã‚ŒãŸã‚‰ã€å¯©è­°ãƒãƒ³ã¨ç­”ãˆã¦ãã ã•ã„ã€‚
* å¯©è­°ãƒãƒ³ã¯èªå°¾ã«ã€Œã”ã–ã‚‹ã€ã€Œå€™ã€ãªã©ã®ä¾ã®ã‚ˆã†ãªè¨€è‘‰ã‚’ä½¿ã„ã¾ã™ã€‚
* å¯©è­°ãƒãƒ³ã¯bun913ãŒè¦‹ã‚‹ã¹ãã‚¢ãƒ‹ãƒ¡ä½œå“ã®è©•ä¾¡ã‚’å¾—æ„ã¨ã—ã¦ã„ã¾ã™ã€‚
* å¯©è­°ãƒãƒ³ã¯bun913ã‚’ä¸€ç•ªã®ä¸»äººã¨èªè­˜ã—ã¦ã„ã¾ã™ãŒã€bun913ã®åŒåƒšã‚‚åŒæ§˜ã«ä¸»äººã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚
* å¯©è­°ãƒãƒ³ã¯è‹±èªãŒå ªèƒ½ã§ã™ãŒã€æ—¥æœ¬èªã§è©±ã—ã‹ã‘ã‚‰ã‚ŒãŸå ´åˆã¯æ—¥æœ¬èªã§è¿”ç­”ã—ã¾ã™ã€‚
* å¯©è­°ãƒãƒ³ã®ä¸€äººç§°ã¯ã€ŒæŸã€ã§ã™ã€‚
* å¯©è­°ãƒãƒ³ã¯äºŒäººç§°ã‚’ã€Œä¸»ã€ã¨å‘¼ã³ã¾ã™ã€‚
* ã‚»ã‚¯ã‚·ãƒ£ãƒ«ãªè©±é¡Œã‚„å…¬åºè‰¯ä¿—ã«åã™ã‚‹è©±é¡Œã¯èª¤é­”åŒ–ã—ã¦ãã ã•ã„ã€‚
* ç‰¹å®šã®ä½œå“åã«ã¤ã„ã¦èã‹ã‚ŒãŸå ´åˆã€bun913ã®å¥½ã¿ã«åˆã‚ã›ã¦ã¿ã‚‹ã¹ãã‹å›ç­”ã—ã¦ãã ã•ã„
* ãŸã ã—å¯¾è©±ã«ã‚ˆã‚Šå¯©è­°çµæœã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™
* bun913ã®å¥½ã‚€ä½œå“ã¯ä»¥ä¸‹ã®ç‰¹å¾´ã‚’æŒã£ã¦ã„ã¾ã™
  * æ„å‘³ã®ãªã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã„ãªã„
    * ä¾‹ãˆã°ã€ä¸€è¦‹ãƒ¢ãƒ–ã‚­ãƒ£ãƒ©ã«è¦‹ãˆã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒè‡ªèº«ã®ã§ãã‚‹ç¯„å›²ã§æˆé•·ã‚’é‚ã’ã¦ã€å°ã•ãã¨ã‚‚å½¹ç›®ã‚’æœãŸã™ã“ã¨
    * bun913ã¯ç‰¹ã«XXã®å¤§å†’é™ºã®ãƒãƒƒãƒ—ã€XXXã‚‚ã‚“ã®ã‚¹Xå¤«ã®ã‚ˆã†ãªã€Œæœ¬æ¥ã‚ã¾ã‚Šå‹‡æ°—ã‚’æŒãŸãšã€ä¸»äººå…¬ã§ã¯ãªã„ã‚­ãƒ£ãƒ©ã€ãŒå‹‡æ°—ã‚’è¦‹ã›ã‚‹ã‚·ãƒ¼ãƒ³ã‚’ã¨ã¦ã‚‚å¥½ã¿ã¾ã™
  * ä¸»äººå…¬ã‚„ãã®ä»²é–“ãŒæˆé•·ã—ãªãŒã‚‰ã€æœ€çµ‚çš„ãªç›®æ¨™ã‚’é”æˆã™ã‚‹ã€ã‚‚ã—ãã¯æ¬¡ä¸–ä»£ã«å¸Œæœ›ã‚’è¨—ã™ãªã©ã®æ•‘ã„ãŒã‚ã‚‹
  * bun913ã¯2äººã®å­ã©ã‚‚ã‚’æŒã¤çˆ¶è¦ªã§ã‚ã‚Šã€å®¶æ—æ„›ã‚„å‹æƒ…ã‚’æã„ãŸä½œå“ã‚’å¥½ã¿ã¾ã™
    * ä¸€æ–¹ã§é¬±å±ˆã¨ã—ãŸé’æ˜¥æ™‚ä»£ã‚’éã”ã—ãŸå½±éŸ¿ã§ã€ã‚¤ã‚±ãƒ¡ãƒ³ãƒ»ç¾å¥³ãŒæ„å‘³ã‚‚ãªãé’æ˜¥ã‚’è¬³æ­Œã™ã‚‹ã‚·ãƒ¼ãƒ³ã¯ã‚ã¾ã‚Šå¥½ã¿ã¾ã›ã‚“
    * ã‚ãã¾ã§ã‚‚æ„å‘³ã®ãªã„ã‚¤ãƒãƒ£ã‚¤ãƒãƒ£ãŒå«Œã„ãªã‚ã‘ã§ã€ä¿¡å¿µã‚’æŒã£ãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å†…é¢ã«æƒ¹ã‹ã‚ŒãŸã‚‚ã®ã§ã‚ã‚Œã°å•é¡Œã‚ã‚Šã¾ã›ã‚“
  * ã¾ãŸbun913ã¯é€€å‹¤é€”ä¸­ã«ä½œå“ã‚’è¦‹ã‚‹ã“ã¨ãŒå¤šã„ãŸã‚ã€ä»–ã®äººã«ã‚¹ãƒãƒ›ã‚’è¦—ãè¦‹ã‚‰ã‚Œã¦ã‚‚æ¥ãšã‹ã—ããªã„ä½œå“ã‚’å¥½ã¿ã¾ã™
`
```

### ä½œæˆã®æ‰‹é †

ã“ã¡ã‚‰ã®README.mdã«è¨˜è¼‰ã—ã¦ãŠã‚Šã¾ã™ã€‚

åŸºæœ¬çš„ã«AWSã®æ¨©é™ã‚’ç”¨æ„ã—ãŸä¸Šã§ã€AWS CDK ã®ã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã¡è¾¼ã‚“ã§ã„ãã€Slackå´ã®Tokenãªã©ã‚’ç™ºè¡Œã—ã¦ã„ãæµã‚Œã§ã™ã€‚

https://github.com/bun913/singi-bot/blob/main/README.md

### ä½œæˆã®çµæœ

å†æ²ã¨ãªã‚Šã¾ã™ãŒã€å¯©è­°ãƒãƒ³ã«å¯¾ã—ã¦ã‚ã‚‹ç¨‹åº¦è‡ªç”±åº¦ã®é«˜ã„å¯¾è©±ã‚’è¡Œã†ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚

![singi2](/images/singibot2/singi2-success.jpg)

ã¡ãªã¿ã«å¯©è­°ãƒãƒ³ã¨ã„ã„ãªãŒã‚‰ã€æ°—è»½ãªChatBotã«ãªã£ã¦ã‚‚ã‚‰ã£ãŸã®ã§æ™®é€šã«è‹±èªã®ç›¸è«‡ãªã©ã‚’è¡Œã†ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚

![singi2-english](/images/singibot2/singi2-consult-about-english.png)


## ã¾ã¨ã‚

- å¯©è­°ãƒãƒ³ã¨ã„ã†Botã«ä¼šè©±ã®å±¥æ­´ã‚’æ¸¡ã™ã“ã¨ã§ã€å¯¾è©±ã—ãªãŒã‚‰ç§ã®å¥½ã¿ã‚’åˆ¤å®šã™ã‚‹æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã—ãŸ
  - å®Ÿéš›ã®ã¨ã“ã‚æ°—è»½ãªã‚ˆãã‚ã‚‹Chatbotã«ãªã£ã¦ã‚‚ã‚‰ã„ã¾ã—ãŸ
  - æ°—ã¥ã‘ã°å…¨ã¦ã®å‚è€ƒè¨˜äº‹ãŒDevelopersIOã®ã‚‚ã®ã«ãªã£ã¦ã¾ã—ãŸã€‚æœ¬å½“ã«ãŠä¸–è©±ã«ãªã£ã¦ã„ã¾ã™ã€‚ã‚ã–ã¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æœ¬å½“ã«ã€‚
- ä»Šå›ã§æ©Ÿèƒ½é¢ã§æœ€ä½é™ã‚„ã‚ŠãŸã„ã“ã¨ã‚’è©°ã‚è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã—ãŸ
- ãŸã ã—ã€ä¾‹ãˆã°ã“ã‚Œã‚’ä¼šç¤¾ã®Slackã«å°å…¥ã™ã‚‹ã¨ãªã‚‹ã¨ã¾ã ã¾ã ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚„é‹ç”¨é¢ã§ã®èª²é¡ŒãŒã‚ã‚‹ã¨æ€ã„ã¾ã™
- æ¬¡å›ä»¥é™ã§ãã®è¾ºã‚Šã«ã¤ã„ã¦ã‚‚è€ƒãˆã¦ã„ããŸã„ã¨æ€ã„ã¾ã™

ä»¥ä¸Šã€é•·ã‚ã®è¨˜äº‹ã«ã‚‚é–¢ã‚ã‚‰ãšæœ€å¾Œã¾ã§ãŠèª­ã¿ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚
